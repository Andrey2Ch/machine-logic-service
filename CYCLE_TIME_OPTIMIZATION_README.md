# üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Cycle Time - –ò—Ç–æ–≥–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (MLS)

#### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `avg_cycle_time` –≤ —Ç–∞–±–ª–∏—Ü—É `parts`
- **–§–∞–π–ª –º–æ–¥–µ–ª–∏:** `src/models/models.py`
- **–¢–∏–ø:** `Integer` (—Å–µ–∫—É–Ω–¥—ã)
- **Nullable:** `True`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
  - –î–ª—è –Ω–æ–≤—ã—Ö –¥–µ—Ç–∞–ª–µ–π: —Ä—É—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ (–≤–≤–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
  - –î–ª—è –¥–µ—Ç–∞–ª–µ–π —Å –∏—Å—Ç–æ—Ä–∏–µ–π: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ `setup_jobs`

#### ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä
- **–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:** `migrations/add_avg_cycle_time_to_parts.sql`
- **–¢—Ä–∏–≥–≥–µ—Ä:** `update_part_avg_cycle_time()`
- **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º `INSERT` –∏–ª–∏ `UPDATE` –≤ `setup_jobs.cycle_time`

### 2. Backend API (MLS)

–°–æ–∑–¥–∞–Ω—ã 4 –Ω–æ–≤—ã—Ö endpoint'–∞:

#### 1Ô∏è‚É£ `GET /parts/{part_id}/cycle-time` - –ë–´–°–¢–†–´–ô
```typescript
// –ß–∏—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ parts.avg_cycle_time (–±–µ–∑ JOIN'–æ–≤)
Response: {
  "avg_cycle_time": 45  // —Å–µ–∫—É–Ω–¥—ã
}
```
**–°–∫–æ—Ä–æ—Å—Ç—å:** ~2-5ms

---

#### 2Ô∏è‚É£ `POST /parts/cycle-times` - BULK (–û–ü–¢–ò–ú–ê–õ–¨–ù–û! ‚ö°)
```typescript
// –ü–æ–ª—É—á–∞–µ—Ç cycle_time –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –¥–µ—Ç–∞–ª–µ–π –û–î–ù–ò–ú –∑–∞–ø—Ä–æ—Å–æ–º
Request: [123, 456, 789]  // part_ids
Response: {
  "123": 45,
  "456": 60,
  "789": null
}
```
**–°–∫–æ—Ä–æ—Å—Ç—å:** ~5ms –¥–ª—è 100 –¥–µ—Ç–∞–ª–µ–π
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ó–∞–≥—Ä—É–∑–∫–∞ Kanban board

---

#### 3Ô∏è‚É£ `GET /lots/{lot_id}/cycle-time-detailed` - –ü–û–õ–ù–´–ô
```typescript
// –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ "–î–µ—Ç–∞–ª–∏ –ª–æ—Ç–∞"
Response: {
  "avg_cycle_time": 45,
  "min_cycle_time": 38,
  "min_machine_name": "HAAS VF2",
  "min_machinist_name": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
  "total_historical_setups": 15,
  "is_estimated": false  // true = —Ä—É—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
}
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ª–æ—Ç

---

#### 4Ô∏è‚É£ `PUT /parts/{part_id}/cycle-time` - –†–£–ß–ù–û–ô –í–í–û–î
```typescript
// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cycle_time –≤—Ä—É—á–Ω—É—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –¥–µ—Ç–∞–ª–µ–π)
Request: {
  "cycle_time": 45  // —Å–µ–∫—É–Ω–¥—ã
}
Response: {
  "success": true,
  "avg_cycle_time": 45,
  "message": "–í—Ä–µ–º—è —Ü–∏–∫–ª–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: 45 —Å–µ–∫"
}
```
**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** –ó–∞–ø—Ä–µ—â–µ–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –Ω–∞–ª–∞–¥–æ–∫ (HTTP 403)

---

### 3. Frontend (isramat-dashboard)

#### ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ Kanban
**–§–∞–π–ª—ã:**
- `src/app/kanban/page.tsx`
- `src/app/kanban-vertical/page.tsx`

**–ë—ã–ª–æ:** 50 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 50ms = 2500ms ‚ùå
**–°—Ç–∞–ª–æ:** 1 bulk –∑–∞–ø—Ä–æ—Å √ó 5ms = 5ms ‚úÖ

**–£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 500 —Ä–∞–∑!** üöÄ

#### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–∞–ª–∫–∞ "–î–µ—Ç–∞–ª–∏ –ª–æ—Ç–∞"
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π endpoint `/lots/{lot_id}/cycle-time-detailed`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "(–æ—Ü–µ–Ω–∫–∞)" –µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–ª–∞–¥–æ–∫: `[15 –Ω–∞–ª–∞–¥–æ–∫]`

#### ‚úÖ Timeline —Ä–µ–∂–∏–º —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –í–°–ï–• –ª–æ—Ç–æ–≤
- –†–∞–Ω—å—à–µ: —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ª–æ—Ç–æ–≤
- –°–µ–π—á–∞—Å: –¥–ª—è –≤—Å–µ—Ö (–Ω–æ–≤—ã—Ö, assigned, in_production)

---

## üéØ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î (–í–ê–ñ–ù–û!)

```bash
cd machine-logic-service

# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –≤–∞—à–µ–π –ë–î PostgreSQL –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
psql -U your_user -d your_database -f migrations/add_avg_cycle_time_to_parts.sql

# –ò–õ–ò –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Railway/Cloud:
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ migrations/add_avg_cycle_time_to_parts.sql
# –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –ë–î –Ω–∞ Railway
```

**–ß—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è:**
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç –∫–æ–ª–æ–Ω–∫—É `parts.avg_cycle_time`
2. ‚úÖ –°–æ–∑–¥–∞—Å—Ç –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. ‚úÖ –†–∞—Å—Å—á–∏—Ç–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–µ—Ç–∞–ª–µ–π
4. ‚úÖ –°–æ–∑–¥–∞—Å—Ç —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –®–∞–≥ 2: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
# MLS
cd machine-logic-service
git add .
git commit -m "feat: optimize cycle_time with parts.avg_cycle_time field

- Add avg_cycle_time column to parts table
- Create trigger for auto-update from setup_jobs
- Add bulk endpoint POST /parts/cycle-times (500x faster!)
- Add detailed endpoint GET /lots/{id}/cycle-time-detailed
- Add manual update endpoint PUT /parts/{id}/cycle-time
- Migration: migrations/add_avg_cycle_time_to_parts.sql"

# Dashboard
cd isramat-dashboard
git add .
git commit -m "feat: optimize Kanban cycle_time loading with bulk requests

- Replace individual requests with single bulk POST /parts/cycle-times
- 500x faster loading (2500ms -> 5ms for 50 lots)
- Load cycle_time for ALL lots (not just new)
- Update modal to use detailed endpoint
- Show '(–æ—Ü–µ–Ω–∫–∞)' for estimated values
- Show historical setup count
- Timeline now works for all lot statuses"
```

### –®–∞–≥ 3: –î–µ–ø–ª–æ–π

```bash
# –î–µ–ø–ª–æ–π –∫–∞–∫ –æ–±—ã—á–Ω–æ
git push
```

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| **–ó–∞–≥—Ä—É–∑–∫–∞ 50 –ª–æ—Ç–æ–≤** | 2500ms | 5ms | **500x** ‚ö° |
| **JOIN'—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ** | 3 (lots, machines, employees) | 0 | **‚àû** |
| **Timeline –¥–ª—è –≤—Å–µ—Ö –ª–æ—Ç–æ–≤** | ‚ùå –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ | ‚úÖ –í—Å–µ | **100%** |
| **–ù–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏** | ‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö | ‚úÖ –ï—Å—Ç—å –æ—Ü–µ–Ω–∫–∞ | **–†–µ—à–µ–Ω–æ** |

---

## üé® UI –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ú–æ–¥–∞–ª–∫–∞ "–î–µ—Ç–∞–ª–∏ –ª–æ—Ç–∞"

**–ü—Ä–∏–º–µ—Ä 1: –î–µ—Ç–∞–ª—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π**
```
–í—Ä–µ–º—è —Ü–∏–∫–ª–∞: 45 sec (min 38 - HAAS VF2 - –ò–≤–∞–Ω–æ–≤ –ò.–ò.) [15 –Ω–∞–ª–∞–¥–æ–∫]
```

**–ü—Ä–∏–º–µ—Ä 2: –ù–æ–≤–∞—è –¥–µ—Ç–∞–ª—å (–æ—Ü–µ–Ω–∫–∞)**
```
–í—Ä–µ–º—è —Ü–∏–∫–ª–∞: 60 sec (–æ—Ü–µ–Ω–∫–∞)
```

**–ü—Ä–∏–º–µ—Ä 3: –î–µ—Ç–∞–ª—å –±–µ–∑ cycle_time**
```
(–í—Ä–µ–º—è —Ü–∏–∫–ª–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è)
```

---

## üîß –î–∞–ª—å–Ω–µ–π—à–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cycle_time –Ω–æ–≤–æ–π –¥–µ—Ç–∞–ª–∏:

**–í–∞—Ä–∏–∞–Ω—Ç 1: API –∑–∞–ø—Ä–æ—Å**
```bash
curl -X PUT "http://localhost:8000/parts/123/cycle-time?cycle_time=45"
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –í UI (TODO - —Å–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É)**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –¥–µ—Ç–∞–ª–∏
- –í –∫–∞—Ä—Ç–æ—á–∫–µ –¥–µ—Ç–∞–ª–∏ (–µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏)

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
- ‚úÖ –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `setup_jobs.cycle_time`
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –ø–æ –≤—Å–µ–º –Ω–∞–ª–∞–¥–∫–∞–º
- ‚úÖ –†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞!** –ë–µ–∑ –Ω–µ–µ –Ω–æ–≤—ã–µ endpoints –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
2. **–¢—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
3. **–°—Ç–∞—Ä—ã–π endpoint `/lots/{lot_id}/cycle-time` –ù–ï —É–¥–∞–ª–µ–Ω** - –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
4. **–ù–æ–≤—ã–π endpoint —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** - `/lots/{lot_id}/cycle-time-detailed`
5. **Frontend —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–µ endpoints

---

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–í 500 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ** –∑–∞–≥—Ä—É–∑–∫–∞ Kanban  
‚úÖ **Timeline —Ä–∞–±–æ—Ç–∞–µ—Ç** –¥–ª—è –≤—Å–µ—Ö –ª–æ—Ç–æ–≤  
‚úÖ **–ù–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏** –∏–º–µ—é—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –≤—Ä–µ–º—è  
‚úÖ **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞–ª–∞–¥–æ–∫  
‚úÖ **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** –≤ –º–æ–¥–∞–ª–∫–µ  
‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É**  

---

**–í–æ–ø—Ä–æ—Å—ã?** –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–∫–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–µ–π –∏–º–µ—é—Ç avg_cycle_time
SELECT COUNT(*) as parts_with_avg_cycle_time 
FROM parts 
WHERE avg_cycle_time IS NOT NULL;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–∏–º–µ—Ä—ã –¥–µ—Ç–∞–ª–µ–π
SELECT 
    p.drawing_number,
    p.avg_cycle_time,
    COUNT(sj.id) as total_setups
FROM parts p
LEFT JOIN setup_jobs sj ON sj.part_id = p.id AND sj.cycle_time IS NOT NULL
WHERE p.avg_cycle_time IS NOT NULL
GROUP BY p.id, p.drawing_number, p.avg_cycle_time
LIMIT 10;
```


